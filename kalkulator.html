<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Neon Kalkulator PRO</title>
    <style>
        :root {
            --bg-main: #000000;
            --bg-body: #050505;
            --neon-red: #ff2222;
            --button-red: #220000;
            --button-red-glow: #ff0000;
            --text-yellow: #ffd700;
            --text-dim: #777777;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            background: var(--bg-main);
            color: var(--text-yellow);
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .calculator {
            background: var(--bg-body);
            border-radius: 32px;
            padding: 16px 16px 12px;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.4);
            width: 340px;
            max-width: 96vw;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .display {
            background: #000000;
            border-radius: 24px;
            padding: 10px 14px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            box-shadow: inset 0 0 12px rgba(255, 255, 255, 0.04);
        }

        .display-top {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        #memory-indicator {
            visibility: hidden;
        }

        #expression {
            min-height: 1.2em;
            font-size: 0.8rem;
            color: var(--text-dim);
            text-align: right;
            word-wrap: break-word;
            word-break: break-all;
        }

        #result {
            min-height: 1.4em;
            font-size: 2rem;
            text-align: right;
            color: var(--text-yellow);
            word-wrap: break-word;
            word-break: break-all;
        }

        .mode-switch {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 2px;
            margin-bottom: 4px;
        }

        .mode-btn {
            flex: 1;
            border: none;
            border-radius: 999px;
            padding: 6px 0;
            background: #050505;
            color: var(--text-dim);
            font-size: 0.8rem;
            cursor: pointer;
            box-shadow: 0 0 6px rgba(0, 0, 0, 0.8);
            transition: all 0.15s ease;
        }

        .mode-btn.active {
            color: var(--text-yellow);
            box-shadow: 0 0 10px var(--button-red-glow);
            border-bottom: 2px solid var(--neon-red);
        }

        .keypad {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .row {
            display: flex;
            justify-content: center;
            gap: 6px;
        }

        .btn {
            flex: 1;
            height: 56px;
            max-width: 70px;
            border-radius: 50%;
            border: none;
            background: var(--button-red);
            color: var(--text-yellow);
            font-size: 1.1rem;
            cursor: pointer;
            box-shadow: 0 0 10px var(--button-red-glow);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.06s ease, box-shadow 0.06s ease, background 0.06s ease;
        }

        .btn:active {
            transform: scale(0.94);
            box-shadow: 0 0 4px rgba(255, 0, 0, 0.7);
            background: #440000;
        }

        .btn.function {
            font-size: 0.9rem;
        }

        .btn.operator {
            font-weight: 600;
        }

        .btn.equal {
            background: #330000;
            box-shadow: 0 0 14px var(--neon-red);
            font-weight: 700;
        }

        .btn.equal:active {
            background: #660000;
        }

        .pro-row {
            display: none;
        }

        .calculator[data-mode="pro"] .pro-row {
            display: flex;
        }

        .history {
            margin-top: 6px;
            background: #050505;
            border-radius: 16px;
            padding: 6px;
            border: 1px solid #222222;
            max-height: 160px;
            overflow-y: auto;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-bottom: 4px;
        }

        #clear-history {
            border: none;
            background: transparent;
            color: var(--text-dim);
            font-size: 0.7rem;
            cursor: pointer;
        }

        #clear-history:hover {
            color: var(--text-yellow);
        }

        .history-item {
            width: 100%;
            text-align: left;
            border: none;
            background: #070707;
            color: var(--text-dim);
            font-size: 0.72rem;
            padding: 3px 5px;
            border-radius: 10px;
            margin-bottom: 2px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-item:hover {
            background: #111111;
            color: var(--text-yellow);
        }

        @media (max-width: 360px) {
            .btn {
                height: 52px;
            }
            #result {
                font-size: 1.7rem;
            }
        }
    </style>
</head>
<body>
<div class="calculator" data-mode="standard">
    <div class="display">
        <div class="display-top">
            <span id="mode-label">STANDARD</span>
            <span id="memory-indicator">M</span>
        </div>
        <div id="expression"></div>
        <div id="result">0</div>
    </div>

    <div class="mode-switch">
        <button class="mode-btn active" data-mode="standard">Standard</button>
        <button class="mode-btn" data-mode="pro">Pro</button>
    </div>

    <div class="keypad">
        <!-- Górny rząd: kasowanie, procent, dzielenie -->
        <div class="row">
            <button class="btn function" data-action="all-clear">AC</button>
            <button class="btn function" data-action="backspace">⌫</button>
            <button class="btn function" data-action="percent">%</button>
            <button class="btn operator" data-operator="÷">÷</button>
        </div>

        <!-- Pamięć -->
        <div class="row">
            <button class="btn function" data-action="mplus">M+</button>
            <button class="btn function" data-action="mminus">M-</button>
            <button class="btn function" data-action="mr">MR</button>
            <button class="btn function" data-action="mc">MC</button>
        </div>

        <!-- Cyfry i podstawowe działania -->
        <div class="row">
            <button class="btn digit" data-value="7">7</button>
            <button class="btn digit" data-value="8">8</button>
            <button class="btn digit" data-value="9">9</button>
            <button class="btn operator" data-operator="×">×</button>
        </div>
        <div class="row">
            <button class="btn digit" data-value="4">4</button>
            <button class="btn digit" data-value="5">5</button>
            <button class="btn digit" data-value="6">6</button>
            <button class="btn operator" data-operator="-">-</button>
        </div>
        <div class="row">
            <button class="btn digit" data-value="1">1</button>
            <button class="btn digit" data-value="2">2</button>
            <button class="btn digit" data-value="3">3</button>
            <button class="btn operator" data-operator="+">+</button>
        </div>
        <div class="row">
            <button class="btn digit" data-value="0">0</button>
            <button class="btn digit" data-value=".">.</button>
            <button class="btn function" data-action="sign">±</button>
            <button class="btn operator equal" data-action="equals">=</button>
        </div>

        <!-- PRO – zaawansowane funkcje (działają na aktualnej liczbie / wyniku) -->
        <div class="row pro-row">
            <button class="btn function" data-action="unary" data-op="sqrt">√x</button>
            <button class="btn function" data-action="unary" data-op="square">x²</button>
            <button class="btn function" data-action="unary" data-op="cube">x³</button>
            <button class="btn function" data-action="unary" data-op="inv">1/x</button>
        </div>
        <div class="row pro-row">
            <button class="btn function" data-action="unary" data-op="sin">sin</button>
            <button class="btn function" data-action="unary" data-op="cos">cos</button>
            <button class="btn function" data-action="unary" data-op="tan">tan</button>
            <button class="btn function" data-action="unary" data-op="abs">|x|</button>
        </div>
        <div class="row pro-row">
            <button class="btn function" data-action="unary" data-op="ln">ln</button>
            <button class="btn function" data-action="unary" data-op="log10">log</button>
            <button class="btn function" data-action="unary" data-op="exp">eˣ</button>
            <button class="btn function" data-action="unary" data-op="pow10">10ˣ</button>
        </div>
    </div>

    <div class="history">
        <div class="history-header">
            <span>Historia obliczeń</span>
            <button id="clear-history">Wyczyść</button>
        </div>
        <div id="history-list"></div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const calc = document.querySelector(".calculator");
        const exprEl = document.getElementById("expression");
        const resEl = document.getElementById("result");
        const modeLabel = document.getElementById("mode-label");
        const memoryIndicator = document.getElementById("memory-indicator");
        const modeButtons = document.querySelectorAll(".mode-btn");
        const keypad = document.querySelector(".keypad");
        const historyList = document.getElementById("history-list");
        const clearHistoryBtn = document.getElementById("clear-history");

        let current = "0";          // aktualnie wpisywana liczba (string)
        let operand = null;         // liczba zapamiętana do działania binarnego
        let pendingOperator = null; // "+", "-", "×", "÷"
        let lastExpression = "";    // tekst na górnym wyświetlaczu po obliczeniu
        let justEvaluated = false;
        let memory = 0;
        let history = [];

        function resetResultColor() {
            resEl.style.color = getComputedStyle(document.documentElement)
                .getPropertyValue("--text-yellow")
                .trim() || "#ffd700";
        }

        function formatNumber(num) {
            if (!isFinite(num)) return "BŁĄD";
            const abs = Math.abs(num);
            if (abs !== 0 && (abs >= 1e12 || abs < 1e-9)) {
                return num.toExponential(6).replace("+", "");
            }
            let str = (Math.round(num * 1e10) / 1e10).toString();
            if (str.indexOf(".") !== -1) {
                str = str.replace(/\.?0+$/, "");
            }
            return str;
        }

        function updateDisplays() {
            exprEl.textContent = lastExpression;
            resEl.textContent = current;
            resEl.dataset.rawValue = current;
        }

        function loadState() {
            const storedMem = localStorage.getItem("neonCalcMemory");
            if (storedMem !== null && !isNaN(storedMem)) {
                memory = parseFloat(storedMem);
            }
            updateMemoryIndicator();

            const storedHistory = localStorage.getItem("neonCalcHistory");
            if (storedHistory) {
                try {
                    history = JSON.parse(storedHistory) || [];
                } catch (e) {
                    history = [];
                }
            }
            renderHistory();
        }

        function saveMemory() {
            localStorage.setItem("neonCalcMemory", memory.toString());
        }

        function updateMemoryIndicator() {
            memoryIndicator.style.visibility = memory !== 0 ? "visible" : "hidden";
        }

        function renderHistory() {
            historyList.innerHTML = "";
            history.slice().reverse().forEach(item => {
                const btn = document.createElement("button");
                btn.className = "history-item";
                btn.dataset.expression = item.expression;
                btn.dataset.result = item.result;
                btn.textContent = item.expression + " = " + item.result;
                historyList.appendChild(btn);
            });
        }

        function saveHistory() {
            localStorage.setItem("neonCalcHistory", JSON.stringify(history));
        }

        function addHistory(exp, result) {
            if (!exp) return;
            history.push({ expression: exp, result });
            if (history.length > 50) {
                history.shift();
            }
            saveHistory();
            renderHistory();
        }

        function getCurrentNumber() {
            const n = parseFloat(current);
            return isNaN(n) ? 0 : n;
        }

        function setCurrentFromNumber(num) {
            current = formatNumber(num);
            resEl.textContent = current;
            resEl.dataset.rawValue = num;
        }

        function computeBinary(a, b, op) {
            switch (op) {
                case "+": return a + b;
                case "-": return a - b;
                case "×": return a * b;
                case "÷": return b === 0 ? NaN : a / b;
            }
            return b;
        }

        function inputDigit(d) {
            if (justEvaluated) {
                // Zaczynamy nowe działanie
                current = "0";
                operand = null;
                pendingOperator = null;
                lastExpression = "";
                justEvaluated = false;
                resetResultColor();
            }

            if (current === "0" && d !== ".") {
                current = d;
            } else {
                if (d === ".") {
                    if (!current.includes(".")) {
                        current += ".";
                    }
                } else {
                    current += d;
                }
            }
            resEl.textContent = current;
            resEl.dataset.rawValue = current;
        }

        function handleOperator(op) {
            const value = getCurrentNumber();

            if (pendingOperator !== null && operand !== null && !justEvaluated) {
                const result = computeBinary(operand, value, pendingOperator);
                setCurrentFromNumber(result);
                operand = result;
            } else {
                operand = value;
            }

            pendingOperator = op;
            lastExpression = formatNumber(operand) + " " + op;
            current = "0";
            justEvaluated = false;
            resetResultColor();
            exprEl.textContent = lastExpression;
        }

        function handleEquals() {
            if (pendingOperator === null || operand === null) return;

            const a = operand;
            const b = getCurrentNumber();
            const result = computeBinary(a, b, pendingOperator);

            const formattedResult = formatNumber(result);
            const expressionText = formatNumber(a) + " " + pendingOperator + " " + formatNumber(b);

            lastExpression = expressionText;
            exprEl.textContent = expressionText;
            resEl.textContent = formattedResult;
            resEl.dataset.rawValue = result;

            resEl.style.color = "#ff3333";

            addHistory(expressionText, formattedResult);

            current = formattedResult;
            operand = null;
            pendingOperator = null;
            justEvaluated = true;
        }

        function handleAllClear() {
            current = "0";
            operand = null;
            pendingOperator = null;
            lastExpression = "";
            justEvaluated = false;
            resetResultColor();
            updateDisplays();
        }

        function handleBackspace() {
            if (justEvaluated) {
                // Po obliczeniu backspace działa na aktualny wynik
                justEvaluated = false;
                resetResultColor();
            }
            if (current.length <= 1 || (current.length === 2 && current.startsWith("-"))) {
                current = "0";
            } else {
                current = current.slice(0, -1);
            }
            resEl.textContent = current;
            resEl.dataset.rawValue = current;
        }

        function handleSign() {
            const value = getCurrentNumber();
            const neg = -value;
            setCurrentFromNumber(neg);
        }

        function handlePercent() {
            const value = getCurrentNumber();
            let result;
            if (operand !== null && pendingOperator !== null) {
                // procent od operand
                result = operand * value / 100;
            } else {
                result = value / 100;
            }
            setCurrentFromNumber(result);
        }

        function handleUnary(op) {
            let x = getCurrentNumber();
            let result;
            switch (op) {
                case "sqrt":
                    result = x < 0 ? NaN : Math.sqrt(x);
                    break;
                case "square":
                    result = x * x;
                    break;
                case "cube":
                    result = x * x * x;
                    break;
                case "inv":
                    result = x === 0 ? NaN : 1 / x;
                    break;
                case "sin":
                    result = Math.sin(x);
                    break;
                case "cos":
                    result = Math.cos(x);
                    break;
                case "tan":
                    result = Math.tan(x);
                    break;
                case "abs":
                    result = Math.abs(x);
                    break;
                case "ln":
                    result = x <= 0 ? NaN : Math.log(x);
                    break;
                case "log10":
                    result = x <= 0 ? NaN : Math.log10(x);
                    break;
                case "exp":
                    result = Math.exp(x);
                    break;
                case "pow10":
                    result = Math.pow(10, x);
                    break;
                default:
                    return;
            }

            const formatted = formatNumber(result);
            current = formatted;
            resEl.textContent = formatted;
            resEl.dataset.rawValue = result;

            if (justEvaluated) {
                lastExpression = op + "(" + formatNumber(x) + ")";
                exprEl.textContent = lastExpression;
            }

            justEvaluated = false;
            resetResultColor();
        }

        function handleMemory(action) {
            const value = getCurrentNumber();
            switch (action) {
                case "mplus":
                    memory += value;
                    break;
                case "mminus":
                    memory -= value;
                    break;
                case "mr":
                    setCurrentFromNumber(memory);
                    break;
                case "mc":
                    memory = 0;
                    break;
            }
            updateMemoryIndicator();
            saveMemory();
        }

        // Obsługa kliknięć klawiatury ekranowej
        keypad.addEventListener("click", (e) => {
            const btn = e.target.closest(".btn");
            if (!btn) return;

            const digit = btn.dataset.value;
            const op = btn.dataset.operator;
            const action = btn.dataset.action;

            if (digit !== undefined) {
                inputDigit(digit);
                return;
            }

            if (op !== undefined) {
                handleOperator(op);
                return;
            }

            if (action) {
                switch (action) {
                    case "equals":
                        handleEquals();
                        break;
                    case "all-clear":
                        handleAllClear();
                        break;
                    case "backspace":
                        handleBackspace();
                        break;
                    case "sign":
                        handleSign();
                        break;
                    case "percent":
                        handlePercent();
                        break;
                    case "unary":
                        handleUnary(btn.dataset.op);
                        break;
                    case "mplus":
                    case "mminus":
                    case "mr":
                    case "mc":
                        handleMemory(action);
                        break;
                }
            }
        });

        // Tryb STANDARD / PRO
        modeButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                const mode = btn.dataset.mode;
                calc.setAttribute("data-mode", mode);
                modeButtons.forEach(b => b.classList.toggle("active", b === btn));
                modeLabel.textContent = mode.toUpperCase();
            });
        });

        // Historia – kliknięcie wpisu
        historyList.addEventListener("click", (e) => {
            const item = e.target.closest(".history-item");
            if (!item) return;
            const exp = item.dataset.expression;
            const result = item.dataset.result;
            lastExpression = exp;
            current = result;
            exprEl.textContent = exp;
            resEl.textContent = result;
            resEl.dataset.rawValue = parseFloat(result);
            justEvaluated = true;
            resEl.style.color = "#ff3333";
        });

        // Wyczyść historię
        clearHistoryBtn.addEventListener("click", () => {
            history = [];
            saveHistory();
            renderHistory();
        });

        // Klawiatura fizyczna – szybkie wpisywanie
        document.addEventListener("keydown", (e) => {
            const key = e.key;

            if (key >= "0" && key <= "9") {
                inputDigit(key);
                e.preventDefault();
                return;
            }
            if (key === "." || key === ",") {
                inputDigit(".");
                e.preventDefault();
                return;
            }
            if (key === "+" || key === "-" || key === "*" || key === "/" ) {
                let op;
                if (key === "+") op = "+";
                if (key === "-") op = "-";
                if (key === "*") op = "×";
                if (key === "/") op = "÷";
                handleOperator(op);
                e.preventDefault();
                return;
            }
            if (key === "Enter" || key === "=") {
                handleEquals();
                e.preventDefault();
                return;
            }
            if (key === "Backspace") {
                handleBackspace();
                e.preventDefault();
                return;
            }
            if (key === "Escape") {
                handleAllClear();
                e.preventDefault();
                return;
            }
            if (key === "%") {
                handlePercent();
                e.preventDefault();
                return;
            }
        });

        // Start
        loadState();
        updateDisplays();
    });
</script>
</body>
</html>
